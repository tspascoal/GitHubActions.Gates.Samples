name: Deploy Gate (Reusable)

on:
  workflow_call:
    inputs:
      function-name:
        description: 'The function name to deploy the app to'
        required: true
        type: string
      gate-project-folder:
        description: 'The folder where the gate project is located (in the src folder) Eg: DeployHours.Gate'
        required: true
        type: string
      function-version:
        description: 'The version of the function to deploy'
        required: false
        type: string
        default: '${{ github.repository }}-${{ github.sha }}'
      client-id:
        description: 'The client id of the service principal to use for deployment'
        required: true
        type: string
    secrets:
      tenant-id:
        description: 'The tenant id of the service principal to use for deployment'
        required: true
      subscription-id:
        description: 'The subscription id of the service principal to use for deployment'
        required: true

env:
  CONFIGURATION: Release
  FUNCTION_APP_NAME: '${{ inputs.function-name }}'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: src/${{ inputs.gate-project-folder}}/published
  WORKING_DIRECTORY: src/${{ inputs.gate-project-folder}}

permissions:
  contents: read

jobs:
  build-and-deploy:
    permissions:
      contents: read
      id-token: write

    name: Build and Deploy

    environment:
      name: Prod-${{ inputs.function-name}}
      url: ${{ steps.deployFunction.outputs.app-url }}

    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Setup DotNet
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore "${{ env.WORKING_DIRECTORY }}"
      - name: Build
        run: |
          version=${{ inputs.function-version }}
          if [ -z "$version" ]; then
            version="${{ github.repository }}-${{ github.sha }}"
          fi
          echo "building version $version"
          dotnet build "${{ env.WORKING_DIRECTORY }}" --configuration ${{ env.CONFIGURATION }} --no-restore /p:InformationalVersion="$version"
      - name: Publish
        run: |
          dotnet publish "${{ env.WORKING_DIRECTORY }}" --configuration ${{ env.CONFIGURATION }} --no-build --output "${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}"

      - name: Login to azure
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5
        with:
          client-id: ${{ inputs.client-id }}
          tenant-id: ${{ secrets.tenant-id }}
          subscription-id: ${{ secrets.subscription-id }}

      - name: Deploy Function ${{ env.FUNCTION_APP_NAME }}
        uses: Azure/functions-action@0bd707f87c0b6385742bab336c74e1afc61f6369
        id: deployFunction
        with:
          app-name: ${{ env.FUNCTION_APP_NAME }}
          package: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'

